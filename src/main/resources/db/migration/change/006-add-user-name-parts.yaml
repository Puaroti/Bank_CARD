databaseChangeLog:
  - changeSet:
      id: 006-add-user-name-parts
      author: dev
      changes:
        - addColumn:
            tableName: users
            columns:
              - column:
                  name: last_name
                  type: VARCHAR(100)
              - column:
                  name: first_name
                  type: VARCHAR(100)
              - column:
                  name: patronymic
                  type: VARCHAR(100)
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              -- Заполнить поля ФИО из full_name по формату "Фамилия Имя Отчество"
              UPDATE users
              SET last_name = CASE WHEN regexp_split_to_array(full_name, '\\s+')::text[] IS NOT NULL THEN (regexp_split_to_array(full_name, '\\s+'))[1] ELSE 'UNKNOWN' END,
                  first_name = CASE WHEN array_length(regexp_split_to_array(full_name, '\\s+'), 1) >= 2 THEN (regexp_split_to_array(full_name, '\\s+'))[2] ELSE 'UNKNOWN' END,
                  patronymic = CASE WHEN array_length(regexp_split_to_array(full_name, '\\s+'), 1) >= 3 THEN (regexp_split_to_array(full_name, '\\s+'))[3] ELSE 'UNKNOWN' END;
        - addNotNullConstraint:
            tableName: users
            columnName: last_name
            columnDataType: VARCHAR(100)
        - addNotNullConstraint:
            tableName: users
            columnName: first_name
            columnDataType: VARCHAR(100)
        - addNotNullConstraint:
            tableName: users
            columnName: patronymic
            columnDataType: VARCHAR(100)
      rollback:
        - dropNotNullConstraint:
            tableName: users
            columnName: last_name
            columnDataType: VARCHAR(100)
        - dropNotNullConstraint:
            tableName: users
            columnName: first_name
            columnDataType: VARCHAR(100)
        - dropNotNullConstraint:
        - dropColumn:
            tableName: users
            columnName: patronymic
